# ====================================================================================# Description:	WarmUP script for SharePoint 2007, 2010 & 2013# FileName:		SPSWarmUP.ps1# Author:		Jean-Cyril DROUHIN# Date:			November 15, 2013# Version:		1.0# URL:			http://spswarmup.codeplex.com# Licence:		MS-PL# ====================================================================================# ====================================================================================# INTERNAL FUNCTIONS# ====================================================================================# Region Load SharePoint Powershell Snapin for SharePoint 2010 & 2013# ===================================================================================# Name: 		Load SharePoint Powershell Snapin# Description:	Load SharePoint Powershell Snapin# ===================================================================================Function Load-SharePoint-Powershell{    If ((Get-PsSnapin |?{$_.Name -eq "Microsoft.SharePoint.PowerShell"})-eq $null)    {        Write-Host -ForegroundColor White "--------------------------------------------------------------"        Write-Host -ForegroundColor White " - Loading SharePoint Powershell Snapin..."        Add-PsSnapin Microsoft.SharePoint.PowerShell -ErrorAction Stop | Out-Null        Write-Host -ForegroundColor White "--------------------------------------------------------------"    }}# Region End# Region Load SharePoint Assembly for SharePoint 2007# ===================================================================================# Name: 		Load SharePoint Assembly# Description:	Load SharePoint Assembly# ===================================================================================Function Load-SharePoint-Assembly{	Write-Host -ForegroundColor White "--------------------------------------------------------------"	Write-Host -ForegroundColor White " - Loading Microsoft.SharePoint Assembly..."	[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.SharePoint") | Out-Null	Write-Host -ForegroundColor White "--------------------------------------------------------------"}# Region End# Region Get All Site Collections Url# ===================================================================================# Name: 		Get All Site Collections Url# Description:	Get All Site Collections Url# ===================================================================================Function Get-AllSitesURL{	Write-Host -ForegroundColor White "--------------------------------------------------------------"	Write-Host -ForegroundColor White " - Get URLs of All Site Collection..."	$SitesURL = new-Object System.Collections.ArrayList		$WebAppADM = [microsoft.sharepoint.administration.SPAdministrationWebApplication]::Local	$SitesADM = $WebAppADM.sites		foreach ($sites in $SitesADM)	{ 		[void]$SitesURL.Add($sites.Url)		$sites.Dispose() 	}			$WebSrv = [microsoft.sharepoint.administration.spwebservice]::ContentService	$webApps = $WebSrv.WebApplications	foreach ($webApp in $WebApps)	{     		$sites=$WebApp.sites		foreach ($site in $sites)		{ 		[void]$SitesURL.Add($site.Url)		$site.Dispose() 		}	}	return $SitesURL	Write-Host -ForegroundColor White " "}# Region End# Region Get All Web Applications Url# ===================================================================================# Name: 		Get All Web Applications Url# Description:	Get All Web Applications Url# ===================================================================================Function Get-AllWebAppURL{	Write-Host -ForegroundColor White "--------------------------------------------------------------"	Write-Host -ForegroundColor White " - Get URLs of All Web Applications..."	$WebAppURL = new-Object System.Collections.ArrayList	$farm = [Microsoft.SharePoint.Administration.SPFarm]::Local	# get web services from local farm	$websvcs = $farm.Services | where -FilterScript {$_.GetType() -eq [Microsoft.SharePoint.Administration.SPWebService]}	foreach ($websvc in $websvcs) 	{		foreach ($webapp in $websvc.WebApplications)		{			foreach ($AltUrl in $webapp.AlternateUrls)           {                [void]$WebAppURL.Add($AltUrl.uri)           }		}	}    return $WebAppURL	Write-Host -ForegroundColor White " "	}# Region IE-BrowseUrl# ===================================================================================# Name: 		IE-BrowseUrl# Description:	Open Url in Internet Explorer Window# ===================================================================================Function IE-BrowseUrl([string] $url){	Write-Host -ForegroundColor White " Internet Explorer - Browsing $url"	$TimeOut = 90	$Wait = 0	try	{		$global:ie.Navigate($url)		While ($ie.busy -like "True" -Or $Wait -gt $TimeOut)		{			Start-Sleep -s 1			$Wait++		}	}	catch	{		$pid = $global:ieproc.id		Write-Host "  IE not responding.  Closing process ID $pid"		$global:ie.Quit()		$global:ieproc | Stop-Process -Force		$global:ie = New-Object -com "InternetExplorer.Application"		$global:ie.Navigate("about:blank")		$global:ie.visible = $true		$global:ieproc = (Get-Process -Name iexplore)| Where-Object {$_.MainWindowHandle -eq $global:ie.HWND}	}	Write-Host -ForegroundColor Green "  WebSite successfully loaded in $Wait s"}# Region End# Region Trust Source Path# ===================================================================================# Name: 		IE-AddTrustIntranetUrl# Description:	Add Url in Security Option - Intranet Zone# ===================================================================================Function IE-AddTrustIntranetUrl([string] $url){	$url = $url -replace "https://",""	$url = $url -replace "http://",""	$urlDomain = $url -replace "/",""	if (-not (Test-Path -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\$urlDomain"))	{		Write-Host -ForegroundColor White " - Adding *.$urlDomain to local Intranet security zone..."		New-Item -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains" -Name $urlDomain -ItemType Leaf -Force | Out-Null		New-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\$urlDomain" -Name '*' -value "1" -PropertyType dword -Force | Out-Null	}	Else	{		Write-Host -ForegroundColor White " - $urlDomain already added to local Intranet security zone..."	}}# ===================================================================================## WarmUp Script - MAIN Region## ===================================================================================cls$Host.UI.RawUI.WindowTitle = " -- WarmUP script -- $env:COMPUTERNAME --"# Logging PowerShell script in rtf file $logfolder = Split-Path -parent $MyInvocation.MyCommand.Definition$logTime = Get-Date -Format yyyy-MM-dd_h-mm$logFile = "$logfolder\WarmUP_script_$logTime.rtf"Start-Transcript -Path $logFile -Append -Force$DateStarted = Get-dateWrite-Host -ForegroundColor Green "-----------------------------------"Write-Host -ForegroundColor Green "| Automated Script - WarmUp Urls |"Write-Host -ForegroundColor Green "| Started on: $DateStarted |"Write-Host -ForegroundColor Green "-----------------------------------"# Check Permission LevelIf (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")){	Write-Warning "You do not have Administrator rights to run this script!`nPlease re-run this script as an Administrator!"	Break} else {	# Load SharePoint Powershell Assembly	Load-SharePoint-Assembly	# Get All Web Applications and Site Collections Urls	$Sites = Get-AllSitesURL	$WebApps = Get-AllWebAppURL		# Add Web Application Url in Intranet Security Options for Internet Explorer	Write-Host -ForegroundColor White "--------------------------------------------------------------"	Write-Host -ForegroundColor White " - Add URLs of All Web Applications in Internet Settings/Security ..."	ForEach ($WebApp in $WebApps)	{		IE-AddTrustIntranetUrl($WebApp)	}	# Run Internet Explorer	Write-Host -ForegroundColor White "--------------------------------------------------------------"	Write-Host -ForegroundColor White " - Opening All sites URl with Internet Explorer ..."	$global:ie = New-Object -com "InternetExplorer.Application"	$global:ie.Navigate("about:blank")	$global:ie.visible = $true	$global:ieproc = (Get-Process -Name iexplore)| Where-Object {$_.MainWindowHandle -eq $global:ie.HWND}		ForEach ($Site in $Sites)	{		IE-BrowseUrl ($Site)	}		# Quit Internet Explorer	if ($global:ie)	{		Write-Host -ForegroundColor White "--------------------------------------------------------------"		Write-Host -ForegroundColor White " - Closing Internet Explorer ..."		$global:ie.Quit()	}		$DateEnded = Get-date	Write-Host -ForegroundColor Green "-----------------------------------"	Write-Host -ForegroundColor Green "| Automated Script - WarmUp Urls |"	Write-Host -ForegroundColor Green "| Started on: $DateStarted |"	Write-Host -ForegroundColor Green "| Completed on: $DateEnded |"	Write-Host -ForegroundColor Green "-----------------------------------"		Stop-Transcript	Exit}